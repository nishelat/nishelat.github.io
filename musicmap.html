<!DOCTYPE html>
<html>
  <head>
    <title>Geolocation</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map" style="display: block; z-index: -100; width: 100%; float: right"></div>
    <div id="location" style="z-index: 100; position: fixed; top: 0px; background-color: white; padding: 5px; display: block; width: 100%; text-align: center"></div>
    <div>
    <script>

      // Create the beacon data structures
      var IRC = {
        name: "IRC",
        lat: 34.01919872979596,
        lng: -118.2910743355751
      };
      var Parkside = {
        name: "Parkside",
        lat: 34.018829686202075,
        lng: -118.29098984599113
      };
      var Cromwell = {
        name: "Cromwell",
        lat: 34.02189314403895,
        lng: -118.28770279884338
      };
      var Alumni_Park = {
        name: "Alumni Park",
        lat: 34.0205148240064,
        lng: -118.28453242778778
      };
      var Webb = {
        name: "Webb",
        lat: 34.024765313218026,
        lng: -118.28778326511383
      };
      var The_Row = {
        name: "The Row",
        lat: 34.028384285819754,
        lng: -118.28251540660858
      };
      var EQuad = {
        name: "E-Quad",
        lat: 34.02048370039241,
        lng: -118.28908681869507
      };
      var KAP = {
        name: "KAP",
        lat: 34.02224883589781,
        lng: -118.29104483127594
      };
      var Leavey = {
        name: "Leavey",
        lat: 34.02182200548831,
        lng: -118.28292846679688
      };
      var Tommy_Trojan = {
        name: "Tommy Trojan",
        lat: 34.02036151915764,
        lng: -118.28527808189392
      };

      // Note: This example requires that you consent to location sharing when
      // prompted by your browser. If you see the error "The Geolocation service
      // failed.", it means you probably did not give permission for the browser to
      // locate you.
      var map;
      var infoWindow;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 0, lng: 0},
          zoom: 18
        });

        infoWindow = new google.maps.InfoWindow({map: map});

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

           	// Math.floor(((pos.lat - 34) * 10000));
            // Math.floor(((pos.lat + 119) * 10000));
            
            infoWindow.setPosition(pos);
            infoWindow.setContent('');
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
      }

      function findClosest() {
        // Calculate the current position
        var globalArgs = arguments;
        navigator.geolocation.getCurrentPosition(function(position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          var closestBeacon;
          var currDistance = 999999;   // arbitrarily large value
          for (var i = 0; i < globalArgs.length; i++) {
            var newDistance = Math.sqrt(Math.pow(pos.lat - globalArgs[i].lat, 2) + 
              Math.pow(pos.lng - globalArgs[i].lng, 2));
            console.log(globalArgs[i].name + ": " + Math.round(newDistance * 1000));
            if(newDistance < currDistance) {
              closestBeacon = globalArgs[i].name;
              currDistance = newDistance;
            }
          }
          if(oldBeacon != closestBeacon) {
            oldBeacon = closestBeacon;
          }
          document.getElementById("location").innerHTML = oldBeacon;
          map.setCenter(pos);
          infoWindow.setPosition(pos);
        });
      }

      // var currBeacon = "init";
      // var oldBeacon = "init";
      // var currBeaconDistance = 999999;
      // var newBeaconDistance = 0;
      // function checkLocation() {
      //   navigator.geolocation.getCurrentPosition(function(position) {
      //       var pos = {
      //         lat: position.coords.latitude,
      //         lng: position.coords.longitude
      //       };

      //       oldBeacon = currBeacon;
      //       var displayString = "";

      //       // Calculate distance between curr location and curr beacon
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.018829686202075, 2) + Math.pow(pos.lng + 118.29098984599113, 2));
      //       displayString += "Parkside: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "Parkside";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - IRC.lat, 2) + 
      //         Math.pow(pos.lng - IRC.lng, 2));
      //       displayString += IRC.name + ": " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = IRC.name;
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.02189314403895, 2) + Math.pow(pos.lng + 118.28770279884338, 2));
      //       displayString += "Cromwell: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "Cromwell";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.0205148240064, 2) + Math.pow(pos.lng + 118.28453242778778, 2));
      //       displayString += "Alumni Park: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "Alumni Park";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.024765313218026, 2) + Math.pow(pos.lng + 118.28778326511383, 2));
      //       displayString += "Webb: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "Webb";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.028384285819754, 2) + Math.pow(pos.lng + 118.28251540660858, 2));
      //       displayString += "The Row: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "The Row";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.02048370039241, 2) + Math.pow(pos.lng + 118.28908681869507, 2));
      //       displayString += "E-Quad: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "E-Quad";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.02224883589781, 2) + Math.pow(pos.lng + 118.29104483127594, 2));
      //       displayString += "KAP: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "KAP";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.02182200548831, 2) + Math.pow(pos.lng + 118.28292846679688, 2));
      //       displayString += "Leavey: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "Leavey";
      //         currBeaconDistance = newBeaconDistance;
      //       }
      //       newBeaconDistance = Math.sqrt(Math.pow(pos.lat - 34.02036151915764, 2) + Math.pow(pos.lng + 118.28527808189392, 2));
      //       displayString += "Tommy Trojan: " + Math.round(newBeaconDistance * 1000) + "<br>";
      //       if(newBeaconDistance <= currBeaconDistance) {
      //         currBeacon = "Tommy Trojan";
      //         currBeaconDistance = newBeaconDistance;
      //       }


      //       map.setCenter(pos);
      //       infoWindow.setPosition(pos);

      //       if(currBeacon != oldBeacon) {
      //         document.getElementById("location").innerHTML = "<b>" + currBeacon + "</b>" + "<br>" + displayString;
      //         // if(currBeacon == "IRC") {
                // document.getElementById("music").src = "IRC.mp3";
      //         // }
      //         // else if(currBeacon == "Webb") {
      //         //   document.getElementById("music").src = "Webb.mp3";
      //         // }
      //       }
      //       // console.log(pos.lat + "  " + pos.lng);

      //      });
      // }

      var oldBeacon = "";
      findClosest(IRC, Parkside, Cromwell, Alumni_Park, Webb, The_Row, EQuad, KAP, Leavey, Tommy_Trojan);
      setInterval(function() {findClosest(IRC, Parkside, Cromwell, Alumni_Park, Webb, The_Row, EQuad, KAP, Leavey, Tommy_Trojan)}, 5000);

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBX1hIxjR4crfdluR9WxY_sfybK7RJAUg0&callback=initMap">
    </script>
      <audio id="music" loop autoplay>
        <source type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    </div>
  </body>
</html>